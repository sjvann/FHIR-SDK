## CodeGen 使用手冊

本工具用於依 FHIR 定義（profiles-resources.json）自動產生 .NET 資源類別與註冊表。

### 執行環境需求
- .NET SDK 9.0 以上
- 定義檔位置（R4 或 R5 的 profiles-resources.json）

### 專案位置
- CLI 專案：Tools/CodeGen/CodeGen.csproj
- 進入點：Tools/CodeGen/Program.cs

### 指令參數
- --definitions-root <path|folder>
  - 指定 profiles-resources.json 位置或其父資料夾
  - 可直接給檔案路徑（.../profiles-resources.json），或給資料夾，程式會嘗試下列路徑：
    - <root>/<R4|R5>/profiles-resources.json
    - <root>/<R4|R5 上層>/profiles-resources.json
    - <root>/Definitions/<R4|R5>/profiles-resources.json
    - <root>/profiles-resources.json
- --version <R4|R5>
  - 指定要產生的 FHIR 版本，預設 R5
- --output-project <csproj|folder>
  - 指定輸出專案的 .csproj 或輸出資料夾
  - 產物將寫入 <專案目錄或資料夾>/Generated
- --include <A,B,C>
  - 以逗號分隔指定要產生的資源清單（例如 Patient,Observation）
  - 若省略，會產生所有資源
- --dry-run <true|false>
  - 預設 true；為 true 時只印出將寫入哪些檔案，不會實際寫入

### 範例
1) 產生 R5 的 Patient、Observation、Organization 至 FhirSDK.Resources.R5 專案

```
dotnet run --project tools/CodeGen/CodeGen.csproj -- \
  --definitions-root Definitions \
  --version R5 \
  --output-project FhirSDK.Resources.R5/FhirSDK.Resources.R5.csproj \
  --include Patient,Observation,Organization \
  --dry-run false
```

2) 產生所有 R5 資源至某資料夾（僅預覽，不落檔）

```
dotnet run --project tools/CodeGen/CodeGen.csproj -- \
  --definitions-root Definitions \
  --version R5 \
  --output-project ./out \
  --dry-run true
```

### 產出內容
- <Output>/Generated/ResourceRegistry.<R4|R5>.g.cs
  - 含 Resource 名稱清單的註冊表類別
- <Output>/Generated/<Resource>.g.cs
  - 每個資源一個檔案（例如 Patient.g.cs）

### 產出類別的結構（概要）
- Resource 類別（ResourceBase 衍生）
  - 使用 System.Text.Json 進行序列化
  - 以 [JsonPropertyName("...")] 標注 JSON 欄位
  - 屬性 setter 透過 OnPropertyChangedByClr(nameof(Prop), value) 進行通知與 Raw JSON 同步
- Backbone 類別（BackboneElement<T> 衍生）
  - 同樣使用 [JsonPropertyName("...")] 標注
  - 屬性 setter 使用 OnPropertyChanged("jsonName", value) 進行通知與 Raw JSON 同步
- Choice（[x]）屬性
  - 採互斥邏輯：設定其中一個變體會清空其他變體
  - Resource 層使用 EmitChoiceWithMutex；Backbone 層使用 EmitChoiceWithMutexBackbone

### 使用注意事項
- 請確認 --definitions-root 與 --version 對應正確，程式會自動解析 profiles-resources.json
- --output-project 如果是 .csproj，會以該 csproj 所在資料夾為輸出基準
- 預設為 dry-run（不落檔）；正式產出請加 --dry-run false
- 產出檔案皆帶有 // <auto-generated> 註記，請勿手動修改；若需更動請改動 CodeGen 模板

### 範本與關鍵元件
- 產生器：Tools/CodeGen/Generators/PoCGenerator.cs
  - 建立 Resource 類別、Backbone 類別與註冊表
  - 自動加入 using System.Text.Json.Serialization; 以支援 [JsonPropertyName]
- 屬性模板：Tools/CodeGen/Services/PropertyEmitter.cs
  - Resource：EmitClr、EmitChoiceWithMutex（[JsonPropertyName] + OnPropertyChangedByClr）
  - Backbone：EmitClrBackbone、EmitChoiceWithMutexBackbone（[JsonPropertyName] + OnPropertyChanged）
- 輔助服務：
  - CardinalityService：解析元素基數（必填、可選、是否多值）
  - DocumentationService：讀取定義檔中的簡要說明並輸出成 XML Doc 註解
  - ChoiceService：讀取 choice 成員與對應型別
  - TypeMapService：FHIR 型別 → C# 型別映射

### 常見問題（FAQ）
- Q: 找不到 profiles-resources.json？
  - A: 請檢查 --definitions-root。工具會依序嘗試多個常見路徑；若仍找不到，請直接傳入完整檔案路徑。
- Q: 生成後編譯錯誤 OnPropertyChangedByClr 無法呼叫？
  - A: 該方法存在於 ResourceBase，僅 Resource 類別可用；Backbone 類別會使用 OnPropertyChanged("jsonName", value)。請確認模板未手動修改。
- Q: JsonPropertyName 為何能直接簡寫？
  - A: 專案以 .NET 9 為目標，已全域引用 System.Text.Json。生成的檔案也加入 using System.Text.Json.Serialization;，可直接使用 [JsonPropertyName]。

### 測試
- 建議在生成後執行對應的測試專案：

```
dotnet test FhirSDK.Resources.R5.Tests/FhirSDK.Resources.R5.Tests.csproj -v:m
```

- 本倉庫的測試涵蓋：
  - Primitive JSON 同步測試
  - E2E 測試（如 Patient）
  - Choice 互斥設定行為

### 版本與維護
- 目前支援 R4、R5 兩個版本
- 變更請優先修改 PropertyEmitter 與 PoCGenerator；請勿編輯已生成檔案
- 建議新增快照或快照比對測試，避免模板回歸

