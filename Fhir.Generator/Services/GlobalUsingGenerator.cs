using System.Text;
using Fhir.Generator.Models;

namespace Fhir.Generator.Services;

/// <summary>
/// è‡ªå‹•ç”Ÿæˆ Global Using æª”æ¡ˆçš„æœå‹™
/// è§£æ±ºæ‰‹å‹•å®£å‘Šå¹¾ç™¾å€‹ Resource çš„å•é¡Œ
/// </summary>
public class GlobalUsingGenerator
{
    /// <summary>
    /// ç”Ÿæˆ Global Using æª”æ¡ˆ
    /// </summary>
    /// <param name="schema">FHIR Schema</param>
    /// <param name="fhirVersion">FHIR ç‰ˆæœ¬</param>
    /// <param name="outputPath">è¼¸å‡ºè·¯å¾‘</param>
    public async Task GenerateGlobalUsingsAsync(FhirSchema schema, string fhirVersion, string outputPath)
    {
        var namespaceName = $"Fhir.{fhirVersion}.Models";
        
        var sb = new StringBuilder();
        
        // æª”æ¡ˆæ¨™é ­
        sb.AppendLine("// <auto-generated />");
        sb.AppendLine($"// FHIR {fhirVersion} Global Using Aliases");
        sb.AppendLine("// This file is automatically generated. Do not edit manually.");
        sb.AppendLine($"// Generated on: {DateTime.UtcNow:yyyy-MM-dd HH:mm:ss} UTC");
        sb.AppendLine();
        
        // å…±ç”¨å‘½åç©ºé–“
        sb.AppendLine("// Common namespaces");
        sb.AppendLine("global using System.ComponentModel.DataAnnotations;");
        sb.AppendLine("global using System.Text.Json.Serialization;");
        sb.AppendLine("global using Fhir.Abstractions;");
        sb.AppendLine("global using Fhir.Support.Base;");
        sb.AppendLine();
        
        // Resources
        sb.AppendLine("// FHIR Resources");
        var sortedResources = schema.Resources.Keys.OrderBy(x => x).ToList();
        foreach (var resourceName in sortedResources)
        {
            sb.AppendLine($"global using {resourceName} = {namespaceName}.Resources.{resourceName};");
        }
        sb.AppendLine();
        
        // DataTypes
        sb.AppendLine("// FHIR DataTypes");
        var sortedDataTypes = schema.DataTypes.Keys
            .Where(x => !IsPrimitiveType(x)) // æ’é™¤åŸºæœ¬é¡å‹
            .OrderBy(x => x)
            .ToList();
            
        foreach (var dataTypeName in sortedDataTypes)
        {
            sb.AppendLine($"global using {dataTypeName} = {namespaceName}.DataTypes.{dataTypeName};");
        }
        sb.AppendLine();
        
        // ç‰ˆæœ¬ç‰¹å®šçš„åˆ¥å
        sb.AppendLine($"// {fhirVersion} Version Aliases");
        sb.AppendLine($"global using FhirResource = {namespaceName}.Base.Resource;");
        sb.AppendLine($"global using FhirElement = {namespaceName}.Base.Element;");
        sb.AppendLine($"global using FhirExtension = {namespaceName}.DataTypes.Extension;");
        
        // å¯«å…¥æª”æ¡ˆ
        var globalUsingsPath = Path.Combine(outputPath, "GlobalUsings.g.cs");
        await File.WriteAllTextAsync(globalUsingsPath, sb.ToString());
        
        Console.WriteLine($"âœ… Generated Global Usings: {globalUsingsPath}");
        Console.WriteLine($"   ğŸ“„ {sortedResources.Count} Resources");
        Console.WriteLine($"   ğŸ”§ {sortedDataTypes.Count} DataTypes");
    }
    
    /// <summary>
    /// ç”Ÿæˆç‰ˆæœ¬åˆ‡æ›æŒ‡å—
    /// </summary>
    /// <param name="fhirVersion">FHIR ç‰ˆæœ¬</param>
    /// <param name="outputPath">è¼¸å‡ºè·¯å¾‘</param>
    public async Task GenerateVersionSwitchGuideAsync(string fhirVersion, string outputPath)
    {
        var sb = new StringBuilder();
        
        sb.AppendLine($"# FHIR {fhirVersion} ç‰ˆæœ¬åˆ‡æ›æŒ‡å—");
        sb.AppendLine();
        sb.AppendLine("## ğŸ¯ ç„¡ç¸«ç‰ˆæœ¬åˆ‡æ›");
        sb.AppendLine();
        sb.AppendLine("é€™å€‹å°ˆæ¡ˆå·²ç¶“è‡ªå‹•è¨­å®šäº†æ‰€æœ‰ FHIR Resources å’Œ DataTypes çš„ Global Using åˆ¥åã€‚");
        sb.AppendLine();
        sb.AppendLine("### ä½¿ç”¨æ–¹å¼");
        sb.AppendLine("```csharp");
        sb.AppendLine("// ç›´æ¥ä½¿ç”¨ï¼Œç„¡éœ€ using èªå¥");
        sb.AppendLine("var patient = new Patient();");
        sb.AppendLine("var observation = new Observation();");
        sb.AppendLine("var humanName = new HumanName();");
        sb.AppendLine("```");
        sb.AppendLine();
        sb.AppendLine("### åˆ‡æ›åˆ°å…¶ä»–ç‰ˆæœ¬");
        sb.AppendLine("1. æ”¹è®Šå¥—ä»¶åƒç…§");
        sb.AppendLine("2. é‡æ–°ç”Ÿæˆç¨‹å¼ç¢¼");
        sb.AppendLine("3. ç¨‹å¼ç¢¼è‡ªå‹•é©ç”¨æ–°ç‰ˆæœ¬ï¼");
        sb.AppendLine();
        sb.AppendLine("### ç‰ˆæœ¬è³‡è¨Š");
        sb.AppendLine($"- ç•¶å‰ç‰ˆæœ¬: {fhirVersion}");
        sb.AppendLine($"- ç”Ÿæˆæ™‚é–“: {DateTime.UtcNow:yyyy-MM-dd HH:mm:ss} UTC");
        sb.AppendLine($"- Global Using æª”æ¡ˆ: GlobalUsings.g.cs");
        
        var guidePath = Path.Combine(outputPath, "VERSION_SWITCH_GUIDE.md");
        await File.WriteAllTextAsync(guidePath, sb.ToString());
        
        Console.WriteLine($"âœ… Generated Version Switch Guide: {guidePath}");
    }
    
    /// <summary>
    /// æª¢æŸ¥æ˜¯å¦ç‚ºåŸºæœ¬é¡å‹
    /// </summary>
    private static bool IsPrimitiveType(string typeName)
    {
        var primitiveTypes = new HashSet<string>
        {
            "boolean", "integer", "string", "decimal", "uri", "url", "canonical",
            "base64Binary", "instant", "date", "dateTime", "time", "code", "oid",
            "id", "markdown", "unsignedInt", "positiveInt", "uuid", "xhtml"
        };
        
        return primitiveTypes.Contains(typeName);
    }
}
