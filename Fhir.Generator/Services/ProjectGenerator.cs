using System.Text;
using Fhir.Generator.Models;

namespace Fhir.Generator.Services;

/// <summary>
/// å°ˆæ¡ˆç”Ÿæˆå™¨
/// ç”Ÿæˆå®Œæ•´çš„ Fhir.{ç‰ˆæœ¬}.Models å°ˆæ¡ˆçµæ§‹
/// </summary>
public class ProjectGenerator
{
    /// <summary>
    /// ç”Ÿæˆå®Œæ•´çš„å°ˆæ¡ˆçµæ§‹
    /// </summary>
    /// <param name="fhirVersion">FHIR ç‰ˆæœ¬</param>
    /// <param name="outputDir">è¼¸å‡ºç›®éŒ„</param>
    public async Task GenerateProjectAsync(string fhirVersion, string outputDir)
    {
        Console.WriteLine($"ğŸ“ Generating project structure for {fhirVersion}...");
        
        // å»ºç«‹å°ˆæ¡ˆç›®éŒ„çµæ§‹
        var resourcesDir = Path.Combine(outputDir, "Resources");
        var baseDir = Path.Combine(outputDir, "Base");
        
        Directory.CreateDirectory(outputDir);
        Directory.CreateDirectory(resourcesDir);
        Directory.CreateDirectory(baseDir);
        
        // ç”Ÿæˆ .csproj æª”æ¡ˆ
        await GenerateProjectFileAsync(outputDir, fhirVersion);
        
        // ç”Ÿæˆ GlobalUsings.cs
        await GenerateGlobalUsingsAsync(outputDir, fhirVersion);
        
        // ç”ŸæˆåŸºç¤é¡åˆ¥
        await GenerateBaseClassesAsync(baseDir, fhirVersion);
        
        Console.WriteLine($"âœ… Project structure generated: {outputDir}");
    }
    
    /// <summary>
    /// ç”Ÿæˆå°ˆæ¡ˆæª”æ¡ˆ
    /// </summary>
    private async Task GenerateProjectFileAsync(string projectDir, string fhirVersion)
    {
        var content = $@"<Project Sdk=""Microsoft.NET.Sdk"">

  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
    <RootNamespace>Fhir.{fhirVersion}.Models</RootNamespace>
    <GenerateDocumentationFile>true</GenerateDocumentationFile>
    <DocumentationFile>bin\$(Configuration)\$(TargetFramework)\Fhir.{fhirVersion}.Models.xml</DocumentationFile>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include=""System.ComponentModel.Annotations"" Version=""5.0.0"" />
    <PackageReference Include=""System.Text.Json"" Version=""8.0.5"" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include=""..\Fhir.TypeFramework\Fhir.TypeFramework.csproj"" />
  </ItemGroup>

</Project>";

        var filePath = Path.Combine(projectDir, $"Fhir.{fhirVersion}.Models.csproj");
        await File.WriteAllTextAsync(filePath, content);
        Console.WriteLine($"  âœ… Generated: {filePath}");
    }
    
    /// <summary>
    /// ç”Ÿæˆå…¨åŸŸ using èªå¥
    /// </summary>
    private async Task GenerateGlobalUsingsAsync(string projectDir, string fhirVersion)
    {
        var content = $@"// <auto-generated />
// Global using statements for Fhir.{fhirVersion}.Models

global using System.ComponentModel.DataAnnotations;
global using System.Text.Json.Serialization;
global using Fhir.TypeFramework.DataTypes;
global using Fhir.TypeFramework.Base;

namespace Fhir.{fhirVersion}.Models;
";

        var filePath = Path.Combine(projectDir, "GlobalUsings.cs");
        await File.WriteAllTextAsync(filePath, content);
        Console.WriteLine($"  âœ… Generated: {filePath}");
    }
    
    /// <summary>
    /// ç”ŸæˆåŸºç¤é¡åˆ¥
    /// </summary>
    private async Task GenerateBaseClassesAsync(string baseDir, string fhirVersion)
    {
        // ç”Ÿæˆ Resource åŸºç¤é¡åˆ¥
        var resourceContent = $@"// <auto-generated />
// FHIR {fhirVersion} Base Resource Class

using System.ComponentModel.DataAnnotations;
using System.Text.Json.Serialization;
using Fhir.TypeFramework.DataTypes;

namespace Fhir.{fhirVersion}.Models.Base;

/// <summary>
/// Base class for all FHIR resources.
/// </summary>
public abstract class Resource
{{
    /// <summary>
    /// Resource type name
    /// </summary>
    [JsonPropertyName(""resourceType"")]
    public abstract string ResourceType {{ get; }}

    /// <summary>
    /// Logical id of this artifact
    /// </summary>
    [JsonPropertyName(""id"")]
    public FhirId? Id {{ get; set; }}

    /// <summary>
    /// A human-readable narrative
    /// </summary>
    [JsonPropertyName(""text"")]
    public Narrative? Text {{ get; set; }}

    /// <summary>
    /// Additional content defined by implementations
    /// </summary>
    [JsonPropertyName(""extension"")]
    public List<Extension>? Extension {{ get; set; }}

    /// <summary>
    /// Extensions that cannot be ignored
    /// </summary>
    [JsonPropertyName(""modifierExtension"")]
    public List<Extension>? ModifierExtension {{ get; set; }}

    /// <summary>
    /// Validates this instance according to FHIR rules
    /// </summary>
    public virtual IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
    {{
        yield break;
    }}
}}

/// <summary>
/// Base class for domain resources.
/// </summary>
public abstract class DomainResource : Resource
{{
    /// <summary>
    /// Contained, inline Resources
    /// </summary>
    [JsonPropertyName(""contained"")]
    public List<Resource>? Contained {{ get; set; }}
}}
";

        var resourceFilePath = Path.Combine(baseDir, "Resource.cs");
        await File.WriteAllTextAsync(resourceFilePath, resourceContent);
        Console.WriteLine($"  âœ… Generated: {resourceFilePath}");
    }
} 